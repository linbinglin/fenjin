import streamlit as st
from openai import OpenAI
import os

# è®¾ç½®é¡µé¢åŸºæœ¬é…ç½®
st.set_page_config(
    page_title="AI æ™ºèƒ½åˆ†é•œç”ŸæˆåŠ©æ‰‹",
    page_icon="ğŸ¬",
    layout="wide"
)

# ä¾§è¾¹æ é…ç½®
with st.sidebar:
    st.title("âš™ï¸ è®¾ç½®")
    
    # 1. API é…ç½®
    st.subheader("API é…ç½®")
    api_base = st.text_input(
        "Base URL (ä¸­è½¬åœ°å€)", 
        value="https://blog.tuiwen.xyz/v1", # æ³¨æ„ï¼šOpenAIåº“é€šå¸¸éœ€è¦åœ¨å°¾éƒ¨åŠ /v1ï¼Œå¦‚æœæŠ¥é”™è¯·å°è¯•å»æ‰/v1æˆ–å’¨è¯¢æœåŠ¡å•†
        help="è¯·è¾“å…¥ä¸­è½¬æ¥å£åœ°å€"
    )
    api_key = st.text_input("API Key", type="password", help="è¯·è¾“å…¥ä½ çš„ API Key")
    
    # 2. æ¨¡å‹é€‰æ‹© (æ”¯æŒè‡ªå®šä¹‰è¾“å…¥)
    st.subheader("æ¨¡å‹é€‰æ‹©")
    model_options = [
        "gpt-4o", 
        "claude-3-5-sonnet-20240620", 
        "deepseek-chat", 
        "gemini-pro", 
        "grok-beta", 
        "doubao-pro-4k"
    ]
    selected_model = st.selectbox("é€‰æ‹©é¢„è®¾æ¨¡å‹", model_options)
    custom_model = st.text_input("æˆ–æ‰‹åŠ¨è¾“å…¥ Model ID (ä¼˜å…ˆä½¿ç”¨)", placeholder="ä¾‹å¦‚: gpt-4o-2024-05-13")
    
    final_model = custom_model if custom_model else selected_model
    
    st.divider()
    
    # 3. è§’è‰²è®¾å®š
    st.subheader("ğŸ‘¤ è§’è‰²è®¾å®š (æ ¸å¿ƒ)")
    st.info("ä¸ºäº†ä¿è¯äººç‰©ä¸€è‡´æ€§ï¼Œè¯·è¯¦ç»†æè¿°ä¸»è§’çš„å¤–è²Œã€æœè£…ã€‚")
    character_profile = st.text_area(
        "äººç‰©å°ä¼ /å¤–è²Œæå†™",
        height=300,
        placeholder="ä¾‹å¦‚ï¼š\nèµµæ¸…æœˆï¼šæ¸…å†·ç¾äººï¼Œçœ‰çœ¼æç²¾è‡´ï¼Œè‚¤ç™½å¦‚é›ªï¼Œé“¶ä¸è´è¶å ç ç°ªï¼Œä¸€èº«ç™½è‰²åˆºç»£ç»«ç½—çº±è¡£...\n\nèµµçµæ›¦ï¼šæ˜è‰³å¼ æ‰¬ï¼Œæçœ¼æ¡ƒè‰²è…®ï¼Œè‚¤ç™½å¦‚é›ªï¼Œé»„è‰²å¦†èŠ±è¥¦è£™..."
    )

# ä¸»ç•Œé¢
st.title("ğŸ¬ AI è§†é¢‘åˆ†é•œæè¿°ç”Ÿæˆå™¨")
st.markdown("ä¸Šä¼ å‰§æœ¬æ–‡ä»¶ï¼Œè‡ªåŠ¨è¿›è¡Œåˆ†é•œæ‹†åˆ†ã€ç”»é¢æè¿°(Midjourney)åŠè§†é¢‘æŒ‡ä»¤(å³æ¢¦AI)ç”Ÿæˆã€‚")

# 4. æ–‡ä»¶ä¸Šä¼ 
uploaded_file = st.file_uploader("ğŸ“‚ ä¸Šä¼ åˆ†é•œæ–‡æ¡ˆ (æ”¯æŒ .txt, .md)", type=["txt", "md"])

# æ ¸å¿ƒå¤„ç†é€»è¾‘
if uploaded_file and api_key and character_profile:
    # è¯»å–æ–‡ä»¶å†…å®¹
    stringio = uploaded_file.getvalue().decode("utf-8")
    script_content = stringio
    
    st.write("### ğŸ“„ æ–‡æ¡ˆé¢„è§ˆ")
    with st.expander("ç‚¹å‡»æŸ¥çœ‹åŸå§‹æ–‡æ¡ˆ"):
        st.text(script_content)

    # æŒ‰é’®è§¦å‘
    if st.button("ğŸš€ å¼€å§‹ç”Ÿæˆåˆ†é•œæè¿°"):
        client = OpenAI(api_key=api_key, base_url=api_base)
        
        # --- æ ¸å¿ƒ Prompt è®¾è®¡ ---
        # è¿™é‡ŒåŒ…å«äº†ä½ æ‰€æœ‰çš„é€»è¾‘è¦æ±‚ï¼šæ‹†åˆ†ã€åˆå¹¶ã€ç”»é¢è§†é¢‘åˆ†ç¦»ã€40å­—ç¬¦åŸåˆ™ç­‰
        system_prompt = f"""
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å½±è§†åˆ†é•œå¸ˆå’ŒAIæç¤ºè¯å·¥ç¨‹å¸ˆã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†ç”¨æˆ·æä¾›çš„æ–‡æ¡ˆè½¬åŒ–ä¸ºé«˜è´¨é‡çš„AIç»˜ç”»ï¼ˆMidjourneyï¼‰å’ŒAIè§†é¢‘ï¼ˆå³æ¢¦AIï¼‰æç¤ºè¯ã€‚

### æ ¸å¿ƒä»»åŠ¡ä¸è§„åˆ™ï¼š

1.  **äººç‰©ä¸€è‡´æ€§ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰**ï¼š
    *   å¿…é¡»ä¸¥æ ¼ä½¿ç”¨ç”¨æˆ·æä¾›çš„ã€è§’è‰²è®¾å®šã€‘å†…å®¹ã€‚
    *   åœ¨æ¯ä¸€ä¸ªåˆ†é•œçš„`ç”»é¢æè¿°`ä¸­ï¼Œåªè¦å‡ºç°è¯¥è§’è‰²ï¼Œå¿…é¡»å®Œæ•´å¤è¿°å…¶å¤–è²Œå’Œç€è£…æè¿°ï¼ˆæ‹¬å·å†…çš„Tagå½¢å¼ï¼‰ï¼Œä¸å¾—çœç•¥ï¼Œä»¥ä¿è¯Midjourneyç”Ÿæˆçš„äººç‰©ä¸€è‡´ã€‚

2.  **åˆ†é•œæ‹†åˆ†ä¸åˆå¹¶é€»è¾‘**ï¼š
    *   **æ‹†åˆ†ï¼ˆæ—¶é•¿é™åˆ¶ï¼‰**ï¼šè§†é¢‘ç”Ÿæˆæ¨¡å‹æ¯ä¸ªé•œå¤´åªèƒ½ç”Ÿæˆçº¦5ç§’è§†é¢‘ï¼ˆçº¦å¯¹åº”40ä¸ªä¸­æ–‡å­—ç¬¦ï¼‰ã€‚
        *   æ£€æŸ¥æ¯æ®µæ–‡æ¡ˆé•¿åº¦ã€‚å¦‚æœæ–‡æ¡ˆè¶…è¿‡40ä¸ªå­—ç¬¦ï¼Œæˆ–è€…åŒ…å«å¤æ‚çš„è¿ç»­åŠ¨ä½œï¼Œå¿…é¡»å°†å…¶æ‹†åˆ†ä¸ºåˆ†é•œ 1-1, 1-2 ç­‰ã€‚
        *   æ‹†åˆ†æ—¶ï¼Œç¡®ä¿æ–‡æ¡ˆä¸ç”»é¢æ—¶é—´å¯¹é½ã€‚
    *   **åˆå¹¶**ï¼šå¦‚æœè¿ç»­å‡ å¥æ–‡æ¡ˆéå¸¸çŸ­ï¼ˆå¦‚â€œä»–è¯´ã€‚â€â€œå¥½çš„ã€‚â€ï¼‰ï¼Œä¸”ç”»é¢åœºæ™¯ä¸å˜ï¼Œè¯·åˆå¹¶ä¸ºä¸€ä¸ªåˆ†é•œï¼Œä»¥å…ç”»é¢è¿‡äºç ´ç¢ã€‚

3.  **æè¿°åˆ†ç¦»åŸåˆ™**ï¼š
    *   **ç”»é¢æè¿° (ç”¨äºMidjourney)**ï¼š
        *   åªæè¿°**é™æ€**åœºæ™¯ã€æ„å›¾ã€å…‰å½±ã€äººç‰©çŠ¶æ€ï¼ˆç«™ç«‹ã€åç€ï¼‰ã€‚
        *   **ä¸¥ç¦**å‡ºç°å¤§å¹…åº¦çš„åŠ¨ä½œåŠ¨è¯ï¼ˆå¦‚â€œè½¬èº«ç¦»å¼€â€ã€â€œè·‘å‘è¿œæ–¹â€ï¼‰ï¼Œå› ä¸ºMJç”»ä¸å‡ºè¿ç»­åŠ¨ä½œï¼Œä¼šå¯¼è‡´ç”»é¢æ¨¡ç³Šæˆ–å¥‡æ€ªã€‚
        *   æ ¼å¼ï¼šåœºæ™¯æè¿° + (äººç‰©å¤–è²ŒTag)ã€‚
    *   **è§†é¢‘ç”Ÿæˆ (ç”¨äºå³æ¢¦AI)**ï¼š
        *   æè¿°**åŠ¨æ€**å†…å®¹ã€‚äººç‰©çš„å…·ä½“è¡Œä¸ºï¼ˆè½¬èº«ã€è¡Œèµ°ã€å¤§ç¬‘ï¼‰ã€é•œå¤´çš„è¿åŠ¨ï¼ˆæ¨æ‹‰æ‘‡ç§»ï¼‰ã€‚
        *   å¿…é¡»åŸºäºâ€œç”»é¢æè¿°â€ç”Ÿæˆçš„é™æ€å›¾æ¥æè¿°åŠ¨ä½œã€‚

4.  **è¾“å‡ºæ ¼å¼è¦æ±‚**ï¼š
    è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºæ¯ä¸€ä¸ªåˆ†é•œï¼ˆä¸è¦ä½¿ç”¨Markdownè¡¨æ ¼ï¼Œç›´æ¥æŒ‰å—è¾“å‡ºï¼‰ï¼š

    NO.[åºå·] æ–‡æ¡ˆï¼š[è¿™é‡Œæ”¾æ‹†åˆ†åçš„å¯¹åº”æ–‡æ¡ˆ]
    ç”»é¢æè¿°ï¼š[åœºæ™¯ç¯å¢ƒæè¿°]ï¼Œ[äººç‰©åŠ¨ä½œçŠ¶æ€]ï¼Œ[å…‰å½±/è§†è§’]ï¼Œ(äººç‰©1åå­—ï¼Œå¤–è²Œæè¿°Tag)ï¼Œ(äººç‰©2åå­—ï¼Œå¤–è²Œæè¿°Tag)
    è§†é¢‘ç”Ÿæˆï¼š[å…·ä½“çš„åŠ¨ä½œæè¿°ï¼Œè°åšäº†ä»€ä¹ˆ]ï¼Œ[é•œå¤´è¿é•œæè¿°]ï¼Œ[è¡¨æƒ…å˜åŒ–]
    ---

### ç”¨æˆ·æä¾›çš„è§’è‰²è®¾å®šï¼š
{character_profile}

### å¾…å¤„ç†æ–‡æ¡ˆï¼š
"""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": script_content}
        ]

        st.divider()
        st.write("### ğŸ¬ ç”Ÿæˆç»“æœ")
        
        # åˆ›å»ºå ä½ç¬¦ç”¨äºæµå¼è¾“å‡º
        response_placeholder = st.empty()
        full_response = ""

        try:
            # æµå¼è°ƒç”¨ API
            stream = client.chat.completions.create(
                model=final_model,
                messages=messages,
                stream=True,
                temperature=0.7 
            )
            
            for chunk in stream:
                if chunk.choices[0].delta.content is not None:
                    content = chunk.choices[0].delta.content
                    full_response += content
                    response_placeholder.markdown(full_response)
            
            # ç”Ÿæˆç»“æŸåçš„æç¤º
            st.success("âœ… åˆ†é•œç”Ÿæˆå®Œæˆï¼ä½ å¯ä»¥å¤åˆ¶ä¸Šæ–¹å†…å®¹ä½¿ç”¨ã€‚")
            
        except Exception as e:
            st.error(f"âŒ å‘ç”Ÿé”™è¯¯: {str(e)}")
            st.warning("è¯·æ£€æŸ¥ API Keyã€Base URL æ˜¯å¦æ­£ç¡®ï¼Œæˆ–è€…æ¨¡å‹ ID æ˜¯å¦å¯ç”¨ã€‚")

else:
    if not api_key:
        st.warning("ğŸ‘ˆ è¯·åœ¨å·¦ä¾§ä¾§è¾¹æ è¾“å…¥ API Key")
    if not uploaded_file:
        st.info("ğŸ‘† è¯·ä¸Šä¼ åˆ†é•œæ–‡æ¡ˆæ–‡ä»¶")
    if not character_profile:
        st.info("ğŸ‘ˆ è¯·åœ¨å·¦ä¾§è¾“å…¥è§’è‰²è®¾å®š")
