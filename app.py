import streamlit as st
from openai import OpenAI
import re

# --- å·¥å…·å‡½æ•°ï¼šåƒç´ çº§æ–‡å­—ç»Ÿè®¡ ---
def get_pure_text(text):
    # ç§»é™¤æ‰€æœ‰åˆ†é•œç¼–å· (æ•°å­— + ç‚¹/é¡¿å·)
    text = re.sub(r'\d+[\.ã€]\s*', '', text)
    # ç§»é™¤æ‰€æœ‰ç©ºç™½ç¬¦ã€æ¢è¡Œã€ç©ºæ ¼
    return "".join(text.split())

# --- é¡µé¢é…ç½® ---
st.set_page_config(page_title="å…¨èƒ½åˆ†é•œå¤§å¸ˆ Pro", layout="wide")

# --- ä¾§è¾¹æ é…ç½® ---
st.sidebar.title("ğŸ¬ å¯¼æ¼”å·¥ä½œå°")
api_key = st.sidebar.text_input("1. API Key", type="password")
base_url = st.sidebar.text_input("2. ä¸­è½¬åœ°å€", value="https://blog.tuiwen.xyz/v1")
model_id = st.sidebar.text_input("3. Model ID", value="gpt-4o", help="æ¨èä½¿ç”¨ gpt-4o æˆ– claude-3-5-sonnet")

st.sidebar.divider()
st.sidebar.markdown("""
**ğŸï¸ å¯¼æ¼”æ‰‹å†Œ (V4)ï¼š**
1. **èšåˆä¸æ‹†åˆ†å¹³è¡¡**ï¼šå•è¡Œç›®æ ‡ 30 å­—ï¼Œä¸¥ç¦è¶… 35 å­—ã€‚
2. **åƒç´ é•œåƒ**ï¼šä¸¥ç¦ä¿®æ”¹åŸæ–‡ä»»ä½•æ ‡ç‚¹å’Œæ–‡å­—ã€‚
3. **è§†è§‰é€»è¾‘**ï¼šåŸºäºåŠ¨ä½œã€å¯¹è¯ã€ç¯å¢ƒåˆ‡æ¢åˆ†é•œã€‚
4. **æ‹’ç»æ€»ç»“**ï¼šä¸¥ç¦ AI è‡ªä½œèªæ˜ç²¾ç®€æ–‡æ¡ˆã€‚
""")

# --- ä¸»ç•Œé¢ ---
st.title("ğŸï¸ å…¨èƒ½æ–‡æ¡ˆÂ·åƒç´ çº§è‡ªåŠ¨åˆ†é•œç³»ç»Ÿ")
st.caption("ç‰ˆæœ¬ 4.0 | è§£å†³æ¼å­—ã€åˆ†é•œè¿‡ç¢ã€é€»è¾‘ç”Ÿç¡¬é—®é¢˜ã€‚")

uploaded_file = st.file_uploader("ğŸ“‚ ä¸Šä¼ æ–‡æ¡ˆæ–‡ä»¶ (txt)", type=['txt'])

if uploaded_file is not None:
    # é¢„å¤„ç†ï¼šä¿ç•™åŸæ–‡è¯­ä¹‰ï¼Œä½†æ¸…é™¤å¹²æ‰°æ®µè½
    raw_text = uploaded_file.getvalue().decode("utf-8")
    # ç»Ÿè®¡åŸæ–‡ï¼ˆä¸å«ç©ºæ ¼æ¢è¡Œï¼‰
    input_stream = "".join(raw_text.split())
    input_len = len(input_stream)

    # ç›‘æ§çœ‹æ¿
    st.subheader("ğŸ“Š æ–‡æ¡ˆç¨½æ ¸é¢æ¿")
    c1, c2, c3, c4 = st.columns(4)
    c1.metric("åŸæ–‡æ€»å­—æ•°", f"{input_len} å­—")

    if st.button("ğŸš€ å¯åŠ¨å…¨è‡ªåŠ¨æ·±åº¦åˆ†é•œ"):
        if not api_key:
            st.error("è¯·åœ¨å·¦ä¾§å¡«å…¥ API Key")
        else:
            try:
                # ä¿®æ­£ Base URL
                actual_base = base_url.split('/chat')[0].strip()
                client = OpenAI(api_key=api_key, base_url=actual_base)
                
                with st.spinner('å¯¼æ¼”æ­£åœ¨è¿›è¡Œæ— æŸé€»è¾‘åˆ†é•œ...'):
                    # --- æ ¸å¿ƒç³»ç»ŸæŒ‡ä»¤ï¼šåƒç´ é•œåƒä¸é€»è¾‘èšåˆ ---
                    system_prompt = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ— æŸåˆ†é•œå¯¼æ¼”ã€‚ä½ çš„ä»»åŠ¡æ˜¯å°†æä¾›çš„æ–‡æœ¬è½¬åŒ–ä¸ºåˆ†é•œè„šæœ¬ã€‚
                    
ã€æ ¸å¿ƒçº¢çº¿ - è¿è€…æ‰£åˆ†ã€‘ï¼š
1. **åƒç´ çº§æ— æŸè¿˜åŸ**ï¼šä½ å¿…é¡»åƒé•œåƒä¸€æ ·è¾“å‡ºåŸæ–‡å†…å®¹ã€‚ä¸¥ç¦åˆ é™¤ã€æ·»åŠ ã€ä¿®æ”¹ã€åˆå¹¶æˆ–æ€»ç»“åŸæ–‡ã€‚å³ä¾¿åŸæ–‡æœ‰è¯­ç—…ï¼Œä¹Ÿè¦åŸæ ·ä¿ç•™ã€‚å­—æ•°åå·®å¿…é¡»ä¸º 0ã€‚
2. **35å­—ç‰©ç†æé™**ï¼šæ¯ä¸€è¡Œåˆ†é•œï¼ˆæ¯ä¸ªç¼–å·ï¼‰çš„æ–‡å­—å†…å®¹ç»å¯¹ä¸å…è®¸è¶…è¿‡ 35 ä¸ªå­—ç¬¦ã€‚
3. **è¯­ä¹‰èšåˆé€»è¾‘**ï¼š
   - ç›®æ ‡é•¿åº¦ï¼šå°½é‡è®©æ¯è¡Œæ¥è¿‘ 25-35 å­—ï¼Œä¸è¦æŠŠä¸€å¥è¯æ‹†æˆå‡ ä¸ªå­—çš„ç¢å—ï¼ˆé™¤éæ˜¯å‰§çƒˆåŠ¨ä½œï¼‰ã€‚
   - ä¼˜å…ˆåœ¨â€œã€‚ï¼ï¼Ÿï¼›â€å¤„æ–­å¥ã€‚
   - å…¶æ¬¡åœ¨â€œï¼Œâ€å¤„æ–­å¥ã€‚
   - è‹¥å¥å­è¶…è¿‡ 35 å­—ä¸”æ— æ ‡ç‚¹ï¼Œå¿…é¡»åœ¨è¯è¯­ä¹‹é—´è¿›è¡Œå¼ºåˆ¶ç‰©ç†æ–­å¥ã€‚
4. **åˆ†é•œåˆ‡æ¢å‡†åˆ™**ï¼š
   - è§’è‰²æ›´æ¢å¯¹è¯ã€‚
   - å‘ç”Ÿå¤§åŠ¨ä½œï¼ˆå¦‚ï¼šæ‰‘å€’ã€è¸¹ã€é£ã€è·‘ï¼‰ã€‚
   - åœºæ™¯æˆ–æ—¶é—´å¤§å¹…å˜åŒ–ã€‚
5. **ä¸‡èƒ½é€‚é…**ï¼šæ— è®ºæ–‡æœ¬æ˜¯å¤ä»£ã€ç°ä»£ã€ç§‘æ™®è¿˜æ˜¯æ„è¯†æµï¼Œå‡æŒ‰ç…§è§†è§‰åŠ¨ä½œé€»è¾‘åˆ‡åˆ†ã€‚

ã€æ ¼å¼è¦æ±‚ã€‘ï¼š
1.å†…å®¹ï¼ˆä¸¥ç¦åœ¨å†…å®¹å‰åŠ æè¿°è¯ï¼Œå¦‚â€œç”»é¢ï¼šâ€â€œé•œå¤´ï¼šâ€ï¼Œåªä¿ç•™æ–‡æ¡ˆåŸæ–‡ï¼‰
2.å†…å®¹
..."""

                    response = client.chat.completions.create(
                        model=model_id,
                        messages=[
                            {"role": "system", "content": system_prompt},
                            {"role": "user", "content": f"è¯·å°†ä»¥ä¸‹æ–‡æœ¬è¿›è¡Œ 1:1 æ— æŸåˆ†é•œå¤„ç†ï¼Œå•è¡Œä¸¥æ ¼é™åˆ¶ 35 å­—ï¼Œæ‹’ç»ç¢ç‰‡åŒ–ï¼š\n\n{raw_text}"}
                        ],
                        temperature=0, # é”å®šç¡®å®šæ€§
                    )

                    result = response.choices[0].message.content
                    output_stream = get_pure_text(result)
                    output_len = len(output_stream)
                    
                    # æå–ç¼–å·è¡Œ
                    lines = [l for l in result.split('\n') if re.match(r'^\d+', l.strip())]
                    count = len(lines)

                    # æ›´æ–°çœ‹æ¿
                    c2.metric("åˆ†é•œæ€»æ•°", f"{count} ç»„")
                    c3.metric("å¤„ç†åå­—æ•°", f"{output_len} å­—")
                    diff = output_len - input_len
                    c4.metric("å­—æ•°åå·®", f"{diff} å­—")

                    st.divider()

                    if diff == 0:
                        st.success("âœ… åƒç´ çº§è¿˜åŸï¼šæ–‡å­— 100% å¯¹é½ï¼Œé€»è¾‘åˆç†ã€‚")
                    else:
                        st.error(f"âŒ è¿˜åŸåå·®ï¼š{diff} å­—ã€‚æç¤ºï¼šæ­£æ•°å¤šå­—ï¼Œè´Ÿæ•°æ¼å­—ã€‚")
                        # æ‰¾å‡ºå…·ä½“åå·®
                        if abs(diff) > 0:
                            st.warning("å»ºè®®ï¼š1. æ£€æŸ¥ Model ID æ˜¯å¦ä¸º GPT-4oï¼›2. å¦‚æœæ–‡æ¡ˆè¶…é•¿ï¼Œè¯·åˆ†ä¸¤æ¬¡ä¸Šä¼ å¤„ç†ã€‚")

                    res_c1, res_c2 = st.columns([2, 1])
                    with res_c1:
                        st.text_area("åˆ†é•œè„šæœ¬é¢„è§ˆ", value=result, height=600)
                    with res_c2:
                        st.info(f"ğŸ’¡ **èŠ‚å¥åˆ†æï¼š**\nå¹³å‡æ¯é•œæ‰¿è½½ï¼š{output_len/count:.1f} å­—ã€‚\nè¿™é€šå¸¸å¯¹åº” 4.5-5.2 ç§’çš„è§†é¢‘ç´ æã€‚")
                        st.download_button("ğŸ’¾ ä¸‹è½½æ— æŸåˆ†é•œç¨¿", result, "final_storyboard.txt")

            except Exception as e:
                st.error(f"API è°ƒç”¨å¤±è´¥ï¼š{str(e)}")
