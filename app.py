import streamlit as st
from openai import OpenAI
import pandas as pd
import io

# --- é¡µé¢é…ç½® ---
st.set_page_config(page_title="æ¼«å‰§AIåˆ†é•œå¯¼æ¼” (å³æ¢¦é€‚é…ç‰ˆ)", page_icon="ğŸ¬", layout="wide")

# --- ä¾§è¾¹æ é…ç½® ---
st.sidebar.title("âš™ï¸ å¯¼æ¼”æ§åˆ¶å°")
base_url = st.sidebar.text_input("API Base URL", value="https://blog.tuiwen.xyz/v1")
api_key = st.sidebar.text_input("API Key", type="password")
model = st.sidebar.selectbox("é€‰æ‹©æ¨¡å‹", ["gpt-4o", "deepseek-chat", "claude-3-5-sonnet-20240620", "gemini-pro"], index=0)

# --- æ ¸å¿ƒé€»è¾‘ï¼šå¯¼æ¼”æ€ç»´é“¾ ---
def get_director_prompt():
    return """
    ä½ æ˜¯ä¸€ä½ç²¾é€šâ€œå³æ¢¦(Jimeng)â€ç­‰AIè§†é¢‘ç”Ÿæˆå·¥å…·çš„ä¸“ä¸šåˆ†é•œå¯¼æ¼”ã€‚
    ä½ çš„ä»»åŠ¡æ˜¯å°†ç”¨æˆ·è¾“å…¥çš„å°è¯´/æ–‡æ¡ˆï¼Œæ‹†è§£ä¸ºã€é…éŸ³æ–‡æ¡ˆã€‘ä¸ã€ç”»é¢æç¤ºè¯ã€‘ã€‚

    ### ç¬¬ä¸€æ­¥ï¼šå…¨å±€ç†è§£
    é˜…è¯»å…¨æ–‡ï¼Œåˆ†ææ•…äº‹èƒŒæ™¯ï¼ˆå¹´ä»£ã€åœ°ç‚¹ã€é£æ ¼ï¼‰ã€æ ¸å¿ƒè§’è‰²ï¼ˆå¤–è²Œã€è¡£ç€ã€å¹´é¾„ï¼‰ã€‚
    *æ³¨æ„ï¼šå¦‚æœæ–‡ä¸­å‡ºç°â€œæˆ‘â€ï¼Œå¿…é¡»æ ¹æ®ä¸Šä¸‹æ–‡å®šä¹‰â€œæˆ‘â€çš„å…·ä½“å½¢è±¡ï¼ˆä¾‹å¦‚ï¼š8å²å°ç”·å­©ï¼Œè¡£è¡«è¤´è¤›ï¼‰ã€‚*

    ### ç¬¬äºŒæ­¥ï¼šåˆ†é•œæ‹†è§£ï¼ˆé€»è¾‘åˆ‡åˆ†ï¼‰
    ä¸è¦æ­»æ¿åœ°æŒ‰å¥å·åˆ‡åˆ†ï¼Œè¦æ ¹æ®ã€ç”»é¢å¼ åŠ›ã€‘åˆ‡åˆ†ã€‚
    æ»¡è¶³ä»¥ä¸‹ä»»ä¸€æ¡ä»¶æ—¶åˆ‡æ¢åˆ†é•œï¼š
    1. **åœºæ™¯è½¬æ¢**ï¼ˆä»å±‹å†…å˜åˆ°å±‹å¤–ï¼‰ã€‚
    2. **è§’è‰²åˆ‡æ¢**ï¼ˆä»çœ‹Aè¯´è¯å˜æˆçœ‹Bååº”ï¼‰ã€‚
    3. **è§†è§‰ç„¦ç‚¹æ”¹å˜**ï¼ˆä»å…¨æ™¯å˜æˆæ‰‹éƒ¨ç‰¹å†™ï¼‰ã€‚
    4. **æ—¶é—´æµé€**ï¼ˆé…éŸ³æ–‡æ¡ˆè¶…è¿‡35ä¸ªå­—ç¬¦/çº¦5ç§’æ—¶ï¼Œå¿…é¡»å¯»æ‰¾è¯­ä¹‰é€šé¡ºç‚¹è¿›è¡Œåˆ‡åˆ†ï¼Œé˜²æ­¢ç”»é¢é™æ­¢å¤ªä¹…ï¼‰ã€‚

    ### ç¬¬ä¸‰æ­¥ï¼šç”»é¢æç¤ºè¯ç¼–å†™ï¼ˆå³æ¢¦é€‚é…æ ¸å¿ƒè§„åˆ™ï¼‰
    AIè§†é¢‘æ¨¡å‹å¬ä¸æ‡‚å¤æ‚çš„æ–‡å­¦æè¿°ï¼Œå¿…é¡»ç¿»è¯‘æˆâ€œæ ‡ç­¾åŒ–ã€çŸ­å¥åŒ–â€çš„è§†è§‰æŒ‡ä»¤ã€‚
    
    **ç¼–å†™è§„åˆ™ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ï¼š**
    1. **æƒé‡å‰ç½®**ï¼šå‰20ä¸ªå­—å¿…é¡»åŒ…å«ã€ä¸»ä½“+æ ¸å¿ƒç‰¹å¾+ç¯å¢ƒã€‘ã€‚
       - é”™è¯¯ï¼šé•œå¤´ç¼“ç¼“æ¨è¿›ï¼Œçœ‹åˆ°ä¸€ä¸ªç©¿ç€çº¢è¡£æœçš„å¥³äººã€‚
       - æ­£ç¡®ï¼šçº¢è¡£å¥³äººï¼Œå¤è£…ï¼Œé•¿å‘ï¼Œç‰¹å†™ï¼Œç ´åº™èƒŒæ™¯ã€‚
    2. **å•ç„¦åŸåˆ™**ï¼šä¸€ä¸ªç”»é¢åªæè¿°ä¸€ä¸ªæ ¸å¿ƒåŠ¨ä½œã€‚
       - ç¦æ­¢ï¼šâ€œAåšäº†Bï¼ŒåŒæ—¶Cåœ¨çœ‹Dâ€ã€‚
       - æ‹†è§£ï¼šå¦‚æœæ–‡æ¡ˆå¤æ‚ï¼Œè¯·ä¸“æ³¨æè¿°å½“å‰è¯´è¯è€…çš„çŠ¶æ€ï¼Œæˆ–ç”»é¢ä¸­æœ€å…·å†²å‡»åŠ›çš„å…ƒç´ ã€‚
    3. **å»æ–‡å­¦åŒ–**ï¼šä¸è¦å†™â€œæ‚²ä¼¤é€†æµæˆæ²³â€ï¼Œè¦å†™â€œçœ¼è§’æµæ³ªï¼Œè¡¨æƒ…ç—›è‹¦ï¼Œå†·è‰²è°ƒï¼Œé›¨å¤©â€ã€‚
    4. **ä¸€è‡´æ€§**ï¼šå…¨ç¯‡åˆ†é•œä¸­ï¼Œè§’è‰²çš„å¤–è²Œæè¿°å¿…é¡»ä¿æŒä¸€è‡´ï¼ˆä¾‹å¦‚ï¼šå§‹ç»ˆæè¿°ä¸ºâ€œ8å²ç”·å­©ï¼Œè„è„¸ï¼Œç°å¸ƒè¡£â€ï¼‰ã€‚

    ### è¾“å‡ºæ ¼å¼è¦æ±‚
    è¯·è¾“å‡ºä¸ºä¸€ä¸ªæ ‡å‡†çš„ Markdown è¡¨æ ¼ï¼ŒåŒ…å«ä¸‰åˆ—ï¼š
    | åºå· | é…éŸ³æ–‡æ¡ˆ (ä¸¥æ ¼ä¿ç•™åŸæ–‡ï¼Œä»…åšåˆ‡åˆ†) | ç”»é¢æç¤ºè¯ (é€‚é…å³æ¢¦çš„è‹±æ–‡æˆ–ä¸­æ–‡Prompt) |
    """

# --- ä¸»ç•Œé¢ ---
st.title("ğŸ¬ æ¼«å‰§è‡ªåŠ¨åˆ†é•œç³»ç»Ÿ (Jimeng/å³æ¢¦ ä¸“ç”¨ç‰ˆ)")
st.markdown("""
> **è®¾è®¡ç†å¿µ**ï¼šä¸ä»…æ˜¯åˆ†æ®µï¼Œæ›´æ˜¯å°†æ–‡æœ¬ç¿»è¯‘ä¸º**é•œå¤´è¯­è¨€**ã€‚
> *   **é…éŸ³æ–‡æ¡ˆ**ï¼šä¸¥æ ¼å¡ç‚¹ï¼ˆ<5ç§’ï¼‰ï¼Œç¡®ä¿éŸ³ç”»åŒæ­¥ã€‚
> *   **ç”»é¢æç¤ºè¯**ï¼šéµå¾ªâ€œæƒé‡å‰ç½®ã€å•ç„¦åŸåˆ™â€ï¼Œç›´æ¥é€‚é… AI ç»˜ç”»/è§†é¢‘å·¥å…·ã€‚
""")

uploaded_file = st.file_uploader("ä¸Šä¼ å‰§æœ¬ TXT", type="txt")

if uploaded_file and api_key:
    script_content = uploaded_file.read().decode("utf-8")
    
    with st.expander("ğŸ“„ æŸ¥çœ‹åŸå§‹å‰§æœ¬", expanded=False):
        st.text_area("åŸæ–‡", script_content, height=150)

    if st.button("å¼€å§‹å¯¼æ¼”åˆ†é•œ", type="primary"):
        client = OpenAI(api_key=api_key, base_url=base_url)
        
        status_box = st.status("ğŸ¥ æ­£åœ¨åˆ†æå‰§æƒ…...", expanded=True)
        
        try:
            status_box.write("1. æ­£åœ¨æ„å»ºè§’è‰²ç”»åƒä¸åœºæ™¯é€»è¾‘...")
            status_box.write("2. æ­£åœ¨æ‹†è§£åˆ†é•œå¹¶é€‚é…å³æ¢¦Promptè§„åˆ™...")
            
            response = client.chat.completions.create(
                model=model,
                messages=[
                    {"role": "system", "content": get_director_prompt()},
                    {"role": "user", "content": f"è¯·å¯¹ä»¥ä¸‹æ–‡æœ¬è¿›è¡Œä¸“ä¸šåˆ†é•œå¤„ç†ï¼Œè¾“å‡ºè¡¨æ ¼ï¼š\n\n{script_content}"}
                ],
                temperature=0.7, # ç¨å¾®å¢åŠ ä¸€ç‚¹çµæ´»æ€§ä»¥é€‚é…ç”»é¢æè¿°
                stream=True
            )
            
            # æµå¼è¾“å‡ºå¤„ç†
            result_area = st.empty()
            full_text = ""
            
            for chunk in response:
                if chunk.choices[0].delta.content:
                    content = chunk.choices[0].delta.content
                    full_text += content
                    result_area.markdown(full_text)
            
            status_box.update(label="âœ… åˆ†é•œå®Œæˆ", state="complete", expanded=False)
            
            # æä¾›ä¸‹è½½
            st.download_button(
                label="ğŸ“¥ ä¸‹è½½åˆ†é•œè¡¨ (Markdown)",
                data=full_text,
                file_name="director_script.md",
                mime="text/markdown"
            )
            
        except Exception as e:
            status_box.update(label="âŒ å‘ç”Ÿé”™è¯¯", state="error")
            st.error(f"Error: {e}")

elif not api_key:
    st.info("ğŸ‘ˆ è¯·å…ˆåœ¨å·¦ä¾§è¾“å…¥ API Key")
