import streamlit as st
from openai import OpenAI
import pandas as pd

# --- é¡µé¢åŸºç¡€è®¾ç½® ---
st.set_page_config(
    page_title="æ¼«å‰§AIåˆ†é•œå¯¼æ¼” (å³æ¢¦é€‚é…ç‰ˆ)",
    page_icon="ğŸ¬",
    layout="wide"
)

# ==========================================
# 1. ä¾§è¾¹æ ï¼šAPI ä¸ æ¨¡å‹é…ç½® (æ ¸å¿ƒä¿®å¤éƒ¨åˆ†)
# ==========================================
st.sidebar.title("âš™ï¸ è®¾ç½®æ§åˆ¶å°")

# --- æ¥å£åœ°å€ ---
default_base_url = "https://blog.tuiwen.xyz/v1"
base_url = st.sidebar.text_input(
    "API Base URL (ä¸­è½¬åœ°å€)", 
    value=default_base_url,
    help="è¯·å¡«å†™ç¬¬ä¸‰æ–¹æ¥å£åœ°å€ï¼Œä¾‹å¦‚ï¼šhttps://blog.tuiwen.xyz/v1"
)

# --- API Key ---
api_key = st.sidebar.text_input("API Key", type="password", help="è¯·è¾“å…¥ä½ çš„ API å¯†é’¥")

st.sidebar.divider()

# --- Model ID é€‰æ‹© (ä¿®å¤ï¼šæ”¯æŒä¸‹æ‹‰ + æ‰‹åŠ¨è¾“å…¥) ---
st.sidebar.markdown("### ğŸ¤– æ¨¡å‹é€‰æ‹© (Model ID)")

# é¢„è®¾æ¨¡å‹åˆ—è¡¨
model_options = [
    "gpt-4o",
    "gpt-4o-mini",
    "deepseek-chat",
    "claude-3-5-sonnet-20240620",
    "gemini-pro",
    "doubao-pro-4k"
]

# ä¸‹æ‹‰é€‰æ‹©æ¡†
selected_model = st.sidebar.selectbox(
    "é€‰æ‹©é¢„è®¾æ¨¡å‹", 
    model_options,
    index=0
)

# æ‰‹åŠ¨è¾“å…¥æ¡† (ä¼˜å…ˆçº§é«˜äºä¸‹æ‹‰æ¡†)
custom_model_input = st.sidebar.text_input(
    "æˆ–æ‰‹åŠ¨è¾“å…¥æ¨¡å‹ ID (è‡ªå®šä¹‰)", 
    value="",
    help="å¦‚æœä¸‹æ‹‰åˆ—è¡¨ä¸­æ²¡æœ‰ä½ æƒ³è¦çš„æ¨¡å‹ï¼Œè¯·åœ¨æ­¤ç›´æ¥è¾“å…¥æ¨¡å‹ IDï¼Œä¾‹å¦‚ï¼šgpt-4-turbo"
)

# æœ€ç»ˆå†³å®šä½¿ç”¨çš„æ¨¡å‹ ID
final_model = custom_model_input if custom_model_input.strip() else selected_model

st.sidebar.info(f"å½“å‰ä½¿ç”¨çš„ Model ID: **{final_model}**")


# ==========================================
# 2. æ ¸å¿ƒé€»è¾‘ï¼šå¯¼æ¼”æ€ç»´é“¾ (ä¿ç•™é«˜çº§åˆ†é•œé€»è¾‘)
# ==========================================
def get_director_prompt():
    return """
    ä½ æ˜¯ä¸€ä½ç²¾é€šâ€œå³æ¢¦(Jimeng)â€ç­‰AIè§†é¢‘ç”Ÿæˆå·¥å…·çš„ä¸“ä¸šåˆ†é•œå¯¼æ¼”ã€‚
    ä½ çš„ä»»åŠ¡æ˜¯å°†ç”¨æˆ·è¾“å…¥çš„å°è¯´/æ–‡æ¡ˆï¼Œæ‹†è§£ä¸ºã€é…éŸ³æ–‡æ¡ˆã€‘ä¸ã€ç”»é¢æç¤ºè¯ã€‘ã€‚

    ### ç¬¬ä¸€æ­¥ï¼šå…¨å±€ç†è§£
    é˜…è¯»å…¨æ–‡ï¼Œåˆ†ææ•…äº‹èƒŒæ™¯ï¼ˆå¹´ä»£ã€åœ°ç‚¹ã€é£æ ¼ï¼‰ã€æ ¸å¿ƒè§’è‰²ï¼ˆå¤–è²Œã€è¡£ç€ã€å¹´é¾„ï¼‰ã€‚
    *æ³¨æ„ï¼šå¦‚æœæ–‡ä¸­å‡ºç°â€œæˆ‘â€ï¼Œå¿…é¡»æ ¹æ®ä¸Šä¸‹æ–‡å®šä¹‰â€œæˆ‘â€çš„å…·ä½“å½¢è±¡ï¼ˆä¾‹å¦‚ï¼š8å²å°ç”·å­©ï¼Œè¡£è¡«è¤´è¤›ï¼‰ã€‚*

    ### ç¬¬äºŒæ­¥ï¼šåˆ†é•œæ‹†è§£ï¼ˆé€»è¾‘åˆ‡åˆ†ï¼‰
    ä¸è¦æ­»æ¿åœ°æŒ‰å¥å·åˆ‡åˆ†ï¼Œè¦æ ¹æ®ã€ç”»é¢å¼ åŠ›ã€‘åˆ‡åˆ†ã€‚
    æ»¡è¶³ä»¥ä¸‹ä»»ä¸€æ¡ä»¶æ—¶åˆ‡æ¢åˆ†é•œï¼š
    1. **åœºæ™¯è½¬æ¢**ï¼ˆä»å±‹å†…å˜åˆ°å±‹å¤–ï¼‰ã€‚
    2. **è§’è‰²åˆ‡æ¢**ï¼ˆä»çœ‹Aè¯´è¯å˜æˆçœ‹Bååº”ï¼‰ã€‚
    3. **è§†è§‰ç„¦ç‚¹æ”¹å˜**ï¼ˆä»å…¨æ™¯å˜æˆæ‰‹éƒ¨ç‰¹å†™ï¼‰ã€‚
    4. **æ—¶é—´æµé€**ï¼ˆé…éŸ³æ–‡æ¡ˆè¶…è¿‡35ä¸ªå­—ç¬¦/çº¦5ç§’æ—¶ï¼Œå¿…é¡»å¯»æ‰¾è¯­ä¹‰é€šé¡ºç‚¹è¿›è¡Œåˆ‡åˆ†ï¼Œé˜²æ­¢ç”»é¢é™æ­¢å¤ªä¹…ï¼‰ã€‚

    ### ç¬¬ä¸‰æ­¥ï¼šç”»é¢æç¤ºè¯ç¼–å†™ï¼ˆå³æ¢¦é€‚é…æ ¸å¿ƒè§„åˆ™ï¼‰
    AIè§†é¢‘æ¨¡å‹å¬ä¸æ‡‚å¤æ‚çš„æ–‡å­¦æè¿°ï¼Œå¿…é¡»ç¿»è¯‘æˆâ€œæ ‡ç­¾åŒ–ã€çŸ­å¥åŒ–â€çš„è§†è§‰æŒ‡ä»¤ã€‚
    
    **ç¼–å†™è§„åˆ™ï¼ˆå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰ï¼š**
    1. **æƒé‡å‰ç½®**ï¼šå‰20ä¸ªå­—å¿…é¡»åŒ…å«ã€ä¸»ä½“+æ ¸å¿ƒç‰¹å¾+ç¯å¢ƒã€‘ã€‚
       - é”™è¯¯ï¼šé•œå¤´ç¼“ç¼“æ¨è¿›ï¼Œçœ‹åˆ°ä¸€ä¸ªç©¿ç€çº¢è¡£æœçš„å¥³äººã€‚
       - æ­£ç¡®ï¼šçº¢è¡£å¥³äººï¼Œå¤è£…ï¼Œé•¿å‘ï¼Œç‰¹å†™ï¼Œç ´åº™èƒŒæ™¯ã€‚
    2. **å•ç„¦åŸåˆ™**ï¼šä¸€ä¸ªç”»é¢åªæè¿°ä¸€ä¸ªæ ¸å¿ƒåŠ¨ä½œã€‚
       - ç¦æ­¢ï¼šâ€œAåšäº†Bï¼ŒåŒæ—¶Cåœ¨çœ‹Dâ€ã€‚
       - æ‹†è§£ï¼šå¦‚æœæ–‡æ¡ˆå¤æ‚ï¼Œè¯·ä¸“æ³¨æè¿°å½“å‰è¯´è¯è€…çš„çŠ¶æ€ï¼Œæˆ–ç”»é¢ä¸­æœ€å…·å†²å‡»åŠ›çš„å…ƒç´ ã€‚
    3. **å»æ–‡å­¦åŒ–**ï¼šä¸è¦å†™â€œæ‚²ä¼¤é€†æµæˆæ²³â€ï¼Œè¦å†™â€œçœ¼è§’æµæ³ªï¼Œè¡¨æƒ…ç—›è‹¦ï¼Œå†·è‰²è°ƒï¼Œé›¨å¤©â€ã€‚
    4. **ä¸€è‡´æ€§**ï¼šå…¨ç¯‡åˆ†é•œä¸­ï¼Œè§’è‰²çš„å¤–è²Œæè¿°å¿…é¡»ä¿æŒä¸€è‡´ï¼ˆä¾‹å¦‚ï¼šå§‹ç»ˆæè¿°ä¸ºâ€œ8å²ç”·å­©ï¼Œè„è„¸ï¼Œç°å¸ƒè¡£â€ï¼‰ã€‚

    ### è¾“å‡ºæ ¼å¼è¦æ±‚
    è¯·è¾“å‡ºä¸ºä¸€ä¸ªæ ‡å‡†çš„ Markdown è¡¨æ ¼ï¼ŒåŒ…å«ä¸‰åˆ—ï¼Œä¸è¦è¾“å‡ºä»»ä½•å¼€åœºç™½ï¼š
    | åºå· | é…éŸ³æ–‡æ¡ˆ (ä¸¥æ ¼ä¿ç•™åŸæ–‡ï¼Œä»…åšåˆ‡åˆ†) | ç”»é¢æç¤ºè¯ (é€‚é…å³æ¢¦çš„è‹±æ–‡æˆ–ä¸­æ–‡Prompt) |
    """

# ==========================================
# 3. ä¸»ç•Œé¢ UI
# ==========================================
st.title("ğŸ¬ æ¼«å‰§è‡ªåŠ¨åˆ†é•œç³»ç»Ÿ (å³æ¢¦é€‚é…ç‰ˆ)")
st.markdown(f"å½“å‰æ¥å…¥æ¨¡å‹ï¼š`{final_model}`")

uploaded_file = st.file_uploader("ä¸Šä¼ å‰§æœ¬ TXT æ–‡ä»¶", type="txt")

if uploaded_file:
    script_content = uploaded_file.read().decode("utf-8")
    
    with st.expander("ğŸ“„ ç‚¹å‡»æŸ¥çœ‹/æ”¶èµ·åŸå§‹å‰§æœ¬", expanded=False):
        st.text_area("åŸæ–‡å†…å®¹", script_content, height=150)

    # å¼€å§‹æŒ‰é’®
    if st.button("å¼€å§‹å¯¼æ¼”åˆ†é•œ", type="primary"):
        if not api_key:
            st.error("âŒ è¯·å…ˆåœ¨ä¾§è¾¹æ è¾“å…¥ API Key")
        else:
            # åˆå§‹åŒ– Client
            client = OpenAI(api_key=api_key, base_url=base_url)
            
            status_box = st.status("ğŸ¥ æ­£åœ¨è°ƒåº¦ AI å¯¼æ¼”...", expanded=True)
            result_placeholder = st.empty()
            full_response = ""

            try:
                status_box.write(f"1. å·²è¿æ¥æ¨¡å‹: {final_model}")
                status_box.write("2. æ­£åœ¨è¿›è¡Œè§’è‰²ç”»åƒåˆ†æä¸åˆ†é•œæ‹†è§£...")
                
                # è°ƒç”¨ API
                stream = client.chat.completions.create(
                    model=final_model,
                    messages=[
                        {"role": "system", "content": get_director_prompt()},
                        {"role": "user", "content": f"è¯·å¯¹ä»¥ä¸‹æ–‡æœ¬è¿›è¡Œä¸“ä¸šåˆ†é•œå¤„ç†ï¼Œè¾“å‡ºè¡¨æ ¼ï¼š\n\n{script_content}"}
                    ],
                    temperature=0.7, 
                    stream=True
                )

                # æµå¼è¾“å‡º
                for chunk in stream:
                    if chunk.choices[0].delta.content:
                        content = chunk.choices[0].delta.content
                        full_response += content
                        result_placeholder.markdown(full_response)
                
                status_box.update(label="âœ… åˆ†é•œå¤„ç†å®Œæˆï¼", state="complete", expanded=False)

                # ä¸‹è½½æŒ‰é’®
                st.download_button(
                    label="ğŸ“¥ ä¸‹è½½åˆ†é•œè„šæœ¬ (.md)",
                    data=full_response,
                    file_name="storyboard_jimeng.md",
                    mime="text/markdown"
                )

            except Exception as e:
                status_box.update(label="âŒ å‘ç”Ÿé”™è¯¯", state="error")
                st.error(f"è°ƒç”¨ API å¤±è´¥: {str(e)}")
                st.info("è¯·æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®ï¼Œæˆ–è¯¥æ¨¡å‹ ID æ˜¯å¦æ”¯æŒæ‚¨çš„ä¸­è½¬æ¥å£ã€‚")

elif not uploaded_file:
    st.info("ğŸ‘‹ è¯·ä¸Šä¼ ä¸€ä¸ª TXT æ–‡ä»¶å¼€å§‹ä½¿ç”¨ã€‚")
