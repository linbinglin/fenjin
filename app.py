import streamlit as st
from openai import OpenAI
import re

# é¡µé¢é…ç½®
st.set_page_config(page_title="åŒé‡å¯¹å†²åˆ†é•œåŠ©æ‰‹", page_icon="âš–ï¸", layout="wide")

st.title("âš–ï¸ ç”µå½±è§£è¯´æ–‡æ¡ˆï¼šåŒé‡å¯¹å†²çº ååˆ†é•œå·¥å…·")
st.markdown("""
**åˆ†é•œä¿®æ­£ç­–ç•¥ï¼š**
1. **ç¬¬ä¸€éï¼ˆé€»è¾‘æ‹†è§£ï¼‰**ï¼šä¾§é‡äºå‰§æƒ…è½¬åœºå’ŒåŠ¨ä½œæ‹†åˆ†ï¼Œå»ºç«‹åˆæ­¥ç»“æ„ã€‚
2. **ç¬¬äºŒéï¼ˆçº åè´¨æ£€ï¼‰**ï¼š**èº«ä»½åˆ‡æ¢ä¸ºâ€œè´¨æ£€æ€»ç›‘â€**ã€‚è´Ÿè´£â€œç¢é•œåˆå¹¶â€ä¸â€œé•¿é•œæ‹†åˆ†â€ï¼Œè§£å†³ 10%-50% çš„é€»è¾‘è¯¯å·®ï¼Œç¡®ä¿èŠ‚å¥å¹³è¡¡ã€‚
""")

# --- ä¾§è¾¹æ é…ç½® ---
st.sidebar.header("âš™ï¸ æ ¸å¿ƒé…ç½®")
api_key = st.sidebar.text_input("è¯·è¾“å…¥ API Key", type="password")
base_url = st.sidebar.text_input("ä¸­è½¬æ¥å£åœ°å€", value="https://blog.tuiwen.xyz/v1")

model_options = ["deepseek-chat", "gpt-4o", "claude-3-5-sonnet-20240620", "gemini-1.5-pro"]
selected_model = st.sidebar.selectbox("é€‰æ‹©æ¨¡å‹ (Model ID)", model_options + ["æ‰‹åŠ¨è¾“å…¥"])
model_id = st.sidebar.text_input("è‡ªå®šä¹‰ Model ID", value="deepseek-chat") if selected_model == "æ‰‹åŠ¨è¾“å…¥" else selected_model

# --- æ ¸å¿ƒ Prompt æ·±åº¦é‡æ„ ---

# ç¬¬ä¸€é˜¶æ®µï¼šèº«ä»½â€”â€”å‰§æƒ…å¯¼æ¼”ï¼ˆä¾§é‡é€»è¾‘ï¼‰
PROMPT_STAGE_1 = """ä½ æ˜¯ä¸€ä¸ªç”µå½±å¯¼æ¼”ã€‚
æˆ‘ä¼šç»™ä½ ä¸€æ®µæŠ¹é™¤äº†æ ¼å¼çš„çº¯æ–‡æœ¬ã€‚è¯·ä½ æ ¹æ®ã€åœºæ™¯è½¬åœºã€äººç‰©æ›´æ¢ã€æ ¸å¿ƒåŠ¨ä½œåˆ‡æ¢ã€‘è¿›è¡Œåˆæ­¥åˆ†é•œã€‚
è¦æ±‚ï¼š
1. è¯†åˆ«æ•…äº‹çš„èµ·æ‰¿è½¬åˆã€‚
2. æ¯ä¸€ä¸ªåˆ†é•œå¿…é¡»æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è§†è§‰ç”»é¢ã€‚
3. ä¸¥ç¦æ”¹åŠ¨æˆ–æ¼æ‰åŸæ–‡ä»»ä½•ä¸€ä¸ªå­—ã€‚
æ ¼å¼ï¼šåºå·.å†…å®¹
"""

# ç¬¬äºŒé˜¶æ®µï¼šèº«ä»½â€”â€”é«˜çº§è´¨æ£€æ€»ç›‘ï¼ˆä¾§é‡èŠ‚å¥çº åï¼‰
PROMPT_STAGE_2 = """ä½ ç°åœ¨çš„èº«ä»½æ˜¯ç”µå½±åæœŸã€åˆ†é•œè´¨æ£€æ€»ç›‘ã€‘ã€‚ä½ çš„æƒåŠ›é«˜äºç¬¬ä¸€éåˆ†é•œï¼Œä½ çš„ä»»åŠ¡æ˜¯å¯¹ç¬¬ä¸€éçš„ç»“æœè¿›è¡Œâ€œçº åâ€å’Œâ€œå¼ºåˆ¶ä¼˜åŒ–â€ã€‚

**ä½ çš„è´¨æ£€ä»»åŠ¡æ¸…å•ï¼š**

1. **ç¢é•œåˆå¹¶ï¼ˆè§£å†³è§†è§‰ç–²åŠ³ï¼‰**ï¼š
   - æ£€æŸ¥ç¬¬ä¸€éåˆ†é•œã€‚å¦‚æœæœ‰è¿ç»­çš„ä¸¤ä¸ªæˆ–å¤šä¸ªåˆ†é•œå­—æ•°éå¸¸å°‘ï¼ˆä¾‹å¦‚éƒ½åœ¨12å­—ä»¥å†…ï¼‰ï¼Œä¸”å®ƒä»¬æè¿°çš„æ˜¯åŒä¸€ä¸ªåœºæ™¯æˆ–è¿ç»­åŠ¨ä½œï¼Œè¯·å°†å®ƒä»¬ã€å¼ºåˆ¶åˆå¹¶ã€‘ä¸ºä¸€ä¸ªåˆ†é•œã€‚
   - ç†ç”±ï¼šé¿å…ç”»é¢åˆ‡æ¢è¿‡å¿«å¯¼è‡´è§‚ä¼—çœ¼æ™•ã€‚

2. **é•¿é•œæ‹†åˆ†ï¼ˆè§£å†³éŸ³ç”»è„±èŠ‚ï¼‰**ï¼š
   - æ£€æŸ¥æ¯ä¸€ä¸ªåˆ†é•œã€‚å¦‚æœå­—æ•°è¶…è¿‡ 35 å­—ï¼Œè¯´æ˜å…¶éŸ³é¢‘æ—¶é•¿è¶…è¿‡ 5 ç§’ï¼Œè¿™è¶…å‡ºäº†å•ä¸€é•œå¤´çš„åœç•™æé™ï¼Œä½ å¿…é¡»åœ¨è¯­ä¹‰è½¬æŠ˜å¤„å°†å…¶ã€å¼ºåˆ¶æ‹†åˆ†ã€‘ã€‚
   - ç†ç”±ï¼šç¡®ä¿æ–‡æ¡ˆéŸ³é¢‘èƒ½è·Ÿä¸Šè§†é¢‘ç”»é¢ï¼Œä¸å‡ºç°å£°ç”»é•¿çŸ­ä¸ä¸€ã€‚

3. **æ–‡æœ¬å¯¹é½å®¡è®¡**ï¼š
   - å¿…é¡»å¯¹æ¯”æˆ‘æä¾›çš„â€œåŸå§‹å…¨æ–‡â€ã€‚ç¬¬ä¸€éåˆ†é•œå¾€å¾€ä¼šå› ä¸ºç†è§£é—®é¢˜æ¼æ‰æŸäº›è¡”æ¥è¯ï¼Œä½ å¿…é¡»æŠŠæ¼æ‰çš„éƒ¨åˆ†ç²¾å‡†åœ°æ‰¾å›æ¥ï¼Œå¡«å…¥åˆ°æœ€åˆé€‚çš„åˆ†é•œä¸­ã€‚

4. **ç¦æ­¢å·æ‡’**ï¼š
   - ç»å¯¹ä¸èƒ½åŸæ ·ç…§æŠ„ç¬¬ä¸€éç»“æœã€‚å¦‚æœç¬¬ä¸€éå­˜åœ¨è¶…è¿‡35å­—æˆ–ä½äº12å­—çš„æ®µè½ï¼Œä½ å¿…é¡»å‡ºæ‰‹å¹²é¢„ã€‚

è¾“å‡ºï¼šæœ€ç»ˆä¼˜åŒ–åçš„ã€èŠ‚å¥å¹³è¡¡çš„å®Œæ•´åˆ†é•œåˆ—è¡¨ï¼ˆåºå·.å†…å®¹ï¼‰ã€‚
"""

# --- ä¸»ç•Œé¢ ---
uploaded_file = st.file_uploader("ä¸Šä¼ æ–‡æ¡ˆ (TXT)", type=['txt'])

if uploaded_file is not None:
    # å½»åº•æŠ¹é™¤æ ¼å¼
    raw_content = uploaded_file.getvalue().decode("utf-8")
    cleaned_content = "".join(raw_content.split())
    
    col_in, col_s1, col_s2 = st.columns([1, 1, 1.2])
    
    with col_in:
        st.subheader("1. æ— æ ¼å¼åŸæ–‡")
        st.text_area("Cleaned Text", cleaned_content, height=400)

    if st.button("ğŸš€ å¼€å§‹åŒé‡çº åå¤„ç†"):
        if not api_key:
            st.error("è¯·é…ç½® API Key")
        else:
            client = OpenAI(api_key=api_key, base_url=base_url)
            try:
                # --- ç¬¬ä¸€é˜¶æ®µ ---
                with st.status("æ­£åœ¨è¿›è¡Œé˜¶æ®µä¸€ï¼šå‰§æƒ…é€»è¾‘è§£æ...") as status:
                    res1 = client.chat.completions.create(
                        model=model_id,
                        messages=[
                            {"role": "system", "content": PROMPT_STAGE_1},
                            {"role": "user", "content": cleaned_content}
                        ],
                        temperature=0.3
                    )
                    stage1_out = res1.choices[0].message.content
                    with col_s1:
                        st.subheader("2. ç¬¬ä¸€éï¼šé€»è¾‘åˆåˆ†")
                        st.text_area("Stage 1 (Initial)", stage1_out, height=400)
                    
                    # --- ç¬¬äºŒé˜¶æ®µ ---
                    status.update(label="æ­£åœ¨è¿›è¡Œé˜¶æ®µäºŒï¼šè´¨æ£€çº åï¼ˆåˆå¹¶ä¸æ‹†åˆ†ï¼‰...")
                    res2 = client.chat.completions.create(
                        model=model_id,
                        messages=[
                            {"role": "system", "content": PROMPT_STAGE_2},
                            {"role": "user", "content": f"ã€åŸå§‹å…¨æ–‡ã€‘ï¼š\n{cleaned_content}\n\nã€ç¬¬ä¸€éå¾…æ£€æŸ¥åˆ†é•œã€‘ï¼š\n{stage1_out}"}
                        ],
                        temperature=0.2
                    )
                    final_out = res2.choices[0].message.content
                    status.update(label="åˆ†é•œè´¨æ£€å®Œæˆï¼", state="complete")
                    
                with col_s2:
                    st.subheader("3. æœ€ç»ˆä¿®æ­£ç‰ˆï¼ˆè´¨æ£€é€šè¿‡ï¼‰")
                    st.text_area("Final Corrected Output", final_out, height=400)
                    st.download_button("ä¸‹è½½ç»“æœ", final_out, file_name="final_storyboard_qc.txt")
                    
            except Exception as e:
                st.error(f"å¤„ç†å¤±è´¥: {str(e)}")

# --- æŠ€æœ¯åŸç† ---
st.markdown("---")
st.info("""
**çº ååŸç†è¯´æ˜ï¼š**
- **é’ˆå¯¹ 10% è¯¯å·®æ–‡æ¡ˆ**ï¼šAI è´¨æ£€å‘˜ä¼šå‘ç°ç¬¬ä¸€éå·²ç»å¾ˆå®Œç¾ï¼Œä»…åšæå°å¹…åº¦å¯¹é½æ ¡éªŒã€‚
- **é’ˆå¯¹ 50% è¯¯å·®æ–‡æ¡ˆ**ï¼šAI è´¨æ£€å‘˜ä¼šå‘ç°å¤§é‡è¿‡çŸ­æˆ–è¿‡é•¿çš„åˆ†é•œï¼Œå¹¶å¼ºåˆ¶æ‰§è¡Œâ€œå¤–ç§‘æ‰‹æœ¯å¼â€çš„åˆå¹¶ä¸æ‹†åˆ†ã€‚
- **å¼ºåˆ¶å¯¹æ¯”**ï¼šStage 2 çš„è¾“å…¥åŒæ—¶åŒ…å«â€œåŸæ–‡â€å’Œâ€œåˆå‰ªâ€ï¼Œé€šè¿‡åŒå‘å¯¹æ¯”æ¶ˆé™¤â€œå¹»è§‰â€å’Œâ€œé—æ¼â€ã€‚
""")
