import streamlit as st
from openai import OpenAI
import re

# é¡µé¢é…ç½®
st.set_page_config(page_title="æ™ºèƒ½å¹³è¡¡åˆ†é•œåŠ©æ‰‹", page_icon="ğŸ¬", layout="wide")

st.title("ğŸ¬ ç”µå½±è§£è¯´ç²¾ç»†å¹³è¡¡åˆ†é•œå·¥å…·")
st.markdown("""
**å¹³è¡¡é€»è¾‘ï¼š**
1. **é˜¶æ®µä¸€ï¼ˆå®è§‚é€»è¾‘ï¼‰ï¼š** æ‹†è§£åœºæ™¯ã€äººç‰©å’Œæ ¸å¿ƒåŠ¨ä½œã€‚
2. **é˜¶æ®µäºŒï¼ˆèŠ‚å¥å¹³è¡¡ï¼‰ï¼š** **ä»…é’ˆå¯¹è¶…è¿‡ 35 å­—çš„é•¿åˆ†é•œ**è¿›è¡Œè¯­ä¹‰åˆ†æã€‚åœ¨è¯­ä¹‰è½¬æŠ˜ç‚¹ï¼ˆå¦‚æ ‡ç‚¹ã€è¿è¯ã€æ–°åŠ¨ä½œï¼‰è¿›è¡Œé€‚åº¦æ‹†è§£ã€‚
3. **é¿å‘ï¼š** ç¦æ­¢ç›²ç›®åˆ‡ç¢ï¼Œç¦æ­¢ç”Ÿæˆè¿‡çŸ­ï¼ˆå¦‚ä½äº 10 å­—ï¼‰çš„æ— æ„ä¹‰åˆ†é•œã€‚
""")

# --- ä¾§è¾¹æ é…ç½® ---
st.sidebar.header("âš™ï¸ è®¾ç½®")
api_key = st.sidebar.text_input("è¯·è¾“å…¥ API Key", type="password")
base_url = st.sidebar.text_input("ä¸­è½¬æ¥å£åœ°å€", value="https://blog.tuiwen.xyz/v1")

model_options = ["deepseek-chat", "gpt-4o", "claude-3-5-sonnet-20240620", "gemini-1.5-pro"]
selected_model = st.sidebar.selectbox("é€‰æ‹©æ¨¡å‹ (Model ID)", model_options + ["æ‰‹åŠ¨è¾“å…¥"])
model_id = st.sidebar.text_input("è‡ªå®šä¹‰ Model ID", value="deepseek-chat") if selected_model == "æ‰‹åŠ¨è¾“å…¥" else selected_model

# --- æ ¸å¿ƒ Prompt ä¼˜åŒ– ---

# ç¬¬ä¸€é˜¶æ®µï¼šå‰§æƒ…å¯¼æ¼”é€»è¾‘
PROMPT_STAGE_1 = """ä½ æ˜¯ä¸€ä¸ªä¼˜ç§€çš„ç”µå½±å¯¼æ¼”ã€‚è¯·å¯¹ä»¥ä¸‹æ— æ ¼å¼æ–‡æœ¬è¿›è¡Œåˆæ­¥å‰§æƒ…åˆ†é•œã€‚
è¦æ±‚ï¼š
1. **é€»è¾‘åˆ‡åˆ†**ï¼šä¸¥æ ¼æ ¹æ®åœºæ™¯åˆ‡æ¢ã€è§’è‰²æ›´æ¢ã€é‡å¤§åŠ¨ä½œè½¬æŠ˜è¿›è¡Œåˆ†é•œã€‚
2. **æ–‡æœ¬å¿ å®åº¦**ï¼šä¸å‡†æ”¹åŠ¨ã€åˆ é™¤æˆ–å¢åŠ ä»»ä½•å­—ã€‚
3. **åˆ†é•œæ„Ÿ**ï¼šæ¯ä¸€ä¸ªç¼–å·ä»£è¡¨ä¸€ä¸ªç‹¬ç«‹çš„ç”»é¢æ„å‘ã€‚
æ ¼å¼ï¼šåºå·.å†…å®¹
"""

# ç¬¬äºŒé˜¶æ®µï¼šå‰ªè¾‘å¸ˆå¹³è¡¡é€»è¾‘ï¼ˆæ ¸å¿ƒæ”¹è¿›ï¼‰
PROMPT_STAGE_2 = """ä½ æ˜¯ä¸€ä¸ªèµ„æ·±çš„ç”µå½±å‰ªè¾‘å¸ˆï¼Œæ‹¥æœ‰æä½³çš„å™äº‹èŠ‚å¥æ„Ÿã€‚
ç°åœ¨è¯·ä½ å¯¹â€œåˆç‰ˆåˆ†é•œâ€è¿›è¡ŒèŠ‚å¥ä¼˜åŒ–ã€‚

**æ ¸å¿ƒå¹³è¡¡åŸåˆ™ï¼š**
1. **é•¿åº¦å®¡æŸ¥**ï¼šé€ä¸€æ£€æŸ¥åˆ†é•œã€‚å¦‚æœè¯¥åˆ†é•œå­—æ•°åœ¨ 15-35 å­—ä¹‹é—´ï¼Œä¸”è¯­ä¹‰å®Œæ•´ï¼Œè¯·**ä¿æŒåŸæ ·**ï¼Œä¸è¦æ”¹åŠ¨ã€‚
2. **é•¿é•œå¤´ç²¾å‡†æ‹†è§£**ï¼šåªæœ‰å½“åˆ†é•œè¶…è¿‡ 35 å­—ï¼ˆæ­¤æ—¶è§†é¢‘å¯¹é½éš¾åº¦å¤§ï¼‰æ—¶ï¼Œæ‰éœ€è¦å¯¹å…¶è¿›è¡Œæ‹†åˆ†ã€‚
   - **æ‹†åˆ†ç‚¹å¯»æ‰¾**ï¼šä¸è¦ç›²ç›®æ‹†åˆ†ã€‚è¯·é˜…è¯»æ–‡å­—ï¼Œåœ¨è¯­ä¹‰è½¬æŠ˜å¤„ï¼ˆå¦‚ï¼šè™½ç„¶/ä½†æ˜¯ã€ç„¶åã€äºæ˜¯ï¼‰ã€æ ‡ç‚¹ç¬¦å·å¤„ã€æˆ–åŠ¨ä½œè¿ç»­ä½“ä¸­çš„ä¸‹ä¸€ä¸ªç»†å¾®åŠ¨ä½œå¤„è¿›è¡Œåˆ‡åˆ†ã€‚
3. **æ‹’ç»ç ´ç¢åŒ–**ï¼šä¸¥ç¦å°†æ–‡æ¡ˆæ‹†å¾—ç¨€ç¢ï¼ˆä¾‹å¦‚ä¸€ä¸ªåˆ†é•œåªæœ‰ 3-5 ä¸ªå­—ï¼‰ã€‚åˆ†é•œå¤ªç¢ä¼šå¯¼è‡´è§‚ä¼—è§†è§‰ç–²åŠ³ï¼Œäº§ç”Ÿå¼ºçƒˆè·³åŠ¨æ„Ÿï¼›åˆ†é•œå¤ªé•¿ä¼šå¯¼è‡´éŸ³ç”»å¤±è°ƒã€‚ä½ çš„ç›®æ ‡æ˜¯è®©å¤§éƒ¨åˆ†åˆ†é•œç»´æŒåœ¨ 15-30 å­—çš„é»„é‡‘åŒºé—´ã€‚
4. **å­—æ•°ä¸ç”»é¢å¯¹é½**ï¼šè¯·è®°ä½ï¼Œ35å­—çº¦ç­‰äº5ç§’ã€‚ä½ çš„ç›®æ ‡æ˜¯è®©æ¯ä¸ªåˆ†é•œéƒ½èƒ½åœ¨ 3-6 ç§’å†…å®Œæˆå™è¿°ã€‚
5. **ç»å¯¹ç¦ä»¤**ï¼šç¦æ­¢é—æ¼æˆ–ä¿®æ”¹åŸæ–‡ä»»ä½•æ–‡å­—ã€‚

è¾“å‡ºï¼šæœ€ç»ˆä¼˜åŒ–åçš„å®Œæ•´åˆ†é•œåˆ—è¡¨ï¼ˆåºå·.å†…å®¹ï¼‰ã€‚
"""

# --- ä¸»ç•Œé¢ ---
uploaded_file = st.file_uploader("ä¸Šä¼ æ–‡æ¡ˆæ–‡ä»¶ (TXT)", type=['txt'])

if uploaded_file is not None:
    # å½»åº•æŠ¹é™¤åŸæ®µè½é˜²æ­¢ AI å·æ‡’
    raw_content = uploaded_file.getvalue().decode("utf-8")
    cleaned_content = "".join(raw_content.split())
    
    col_in, col_s1, col_s2 = st.columns([1, 1, 1.2])
    
    with col_in:
        st.subheader("1. æŠ¹é™¤æ ¼å¼åŸæ–‡")
        st.text_area("Cleaned Input", cleaned_content, height=400)

    if st.button("ğŸš€ å¼€å§‹åŒé‡å¹³è¡¡åˆ†é•œ"):
        if not api_key:
            st.error("è¯·é…ç½® API Key")
        else:
            client = OpenAI(api_key=api_key, base_url=base_url)
            try:
                # --- ç¬¬ä¸€é˜¶æ®µ ---
                with st.spinner("é˜¶æ®µ 1ï¼šæ·±åº¦å‰§æƒ…è§£æ..."):
                    res1 = client.chat.completions.create(
                        model=model_id,
                        messages=[
                            {"role": "system", "content": PROMPT_STAGE_1},
                            {"role": "user", "content": cleaned_content}
                        ],
                        temperature=0.3
                    )
                    stage1_out = res1.choices[0].message.content
                with col_s1:
                    st.subheader("2. å‰§æƒ…å¯¼æ¼”åˆå‰ª")
                    st.text_area("Stage 1 Output", stage1_out, height=400)

                # --- ç¬¬äºŒé˜¶æ®µ ---
                with st.spinner("é˜¶æ®µ 2ï¼šå‰ªè¾‘èŠ‚å¥å¹³è¡¡ä¼˜åŒ–..."):
                    res2 = client.chat.completions.create(
                        model=model_id,
                        messages=[
                            {"role": "system", "content": PROMPT_STAGE_2},
                            {"role": "user", "content": f"åˆç‰ˆåˆ†é•œå¦‚ä¸‹ï¼Œè¯·æ‰§è¡Œç²¾å‡†èŠ‚å¥å¹³è¡¡ä¼˜åŒ–ï¼š\n\n{stage1_out}"}
                        ],
                        temperature=0.2
                    )
                    final_out = res2.choices[0].message.content
                with col_s2:
                    st.subheader("3. æœ€ç»ˆèŠ‚å¥å¹³è¡¡åˆ†é•œ")
                    st.text_area("Final Balanced Output", final_out, height=400)
                    st.download_button("ä¸‹è½½ç»“æœ", final_out, file_name="balanced_storyboard.txt")
                    
            except Exception as e:
                st.error(f"å¤„ç†å¤±è´¥: {str(e)}")

# --- é€»è¾‘è¯´æ˜ ---
st.markdown("---")
st.info("""
**æœ¬æ¬¡æ›´æ–°è¯´æ˜ï¼š**
- **æ™ºèƒ½è¿‡æ»¤**ï¼šç¬¬äºŒéå¤„ç†æ—¶ï¼ŒAI ä¼šå…ˆåˆ¤æ–­åˆ†é•œé•¿åº¦ã€‚å¦‚æœé•¿åº¦é€‚ä¸­ï¼ˆ<35å­—ï¼‰ï¼Œå®ƒä¼šè¢«å¼ºåˆ¶è¦æ±‚â€œä¿æŒåŸæ ·â€ã€‚
- **è¯­ä¹‰æ‹†åˆ†**ï¼šå¯¹äºè¶…é•¿åˆ†é•œï¼ŒAI ä¸å†æ˜¯â€œæ•°æ•°åˆ‡åˆ†â€ï¼Œè€Œæ˜¯å¯»æ‰¾è¯­ä¹‰å’ŒåŠ¨ä½œçš„â€œæ°”å£â€è¿›è¡Œæ‹†åˆ†ã€‚
- **è§†è§‰ç–²åŠ³è§„é¿**ï¼šæ˜ç¡®å‘ŠçŸ¥ AI åˆ†é•œè¿‡ç¢ï¼ˆè§†è§‰ç–²åŠ³ï¼‰å’Œè¿‡é•¿ï¼ˆéŸ³ç”»è„±èŠ‚ï¼‰çš„åæœï¼Œä½¿å…¶åœ¨æ‹†åˆ†æ—¶æ›´è°¨æ…ã€‚
""")
