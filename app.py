import streamlit as st
from openai import OpenAI
import re

# é¡µé¢é…ç½®
st.set_page_config(page_title="é€»è¾‘å®¡è®¡åˆ†é•œåŠ©æ‰‹", page_icon="âš–ï¸", layout="wide")

st.title("âš–ï¸ é€»è¾‘å®¡è®¡å¼åˆ†é•œï¼šè§£å†³æ¼åˆ†ä¸è¯¯åˆ")
st.markdown("""
**æœ¬æ¬¡åº•å±‚é€»è¾‘æ›´æ–°ï¼š**
1. **ç¬¬ä¸€éï¼ˆå‰§æƒ…å¯¼æ¼”ï¼‰**ï¼šå¿«é€Ÿå»ºç«‹å‰§æƒ…èŠ‚ç‚¹ã€‚
2. **ç¬¬äºŒéï¼ˆé€»è¾‘å®¡è®¡å¸ˆï¼‰**ï¼š**å¼ºåˆ¶æ‰§è¡Œâ€œç»†èŠ‚è¡¥æ¼â€**ã€‚å®ƒä¼šåƒæ‹¿ç€æ”¾å¤§é•œä¸€æ ·ï¼Œæ£€æŸ¥ç¬¬ä¸€éåˆ†é•œä¸­é‚£äº›è¢«â€œç³Šå¼„â€è¿‡å»çš„é•¿å¥å­ï¼Œä»¥åŠé‚£äº›è¢«åˆ‡å¾—è¿‡äºç»†ç¢çš„åºŸè¯ã€‚
""")

# --- ä¾§è¾¹æ é…ç½® ---
st.sidebar.header("âš™ï¸ é…ç½®ä¸­å¿ƒ")
api_key = st.sidebar.text_input("è¯·è¾“å…¥ API Key", type="password")
base_url = st.sidebar.text_input("ä¸­è½¬æ¥å£åœ°å€", value="https://blog.tuiwen.xyz/v1")

model_options = ["gpt-4o", "claude-3-5-sonnet-20240620", "deepseek-chat", "gemini-1.5-pro"]
selected_model = st.sidebar.selectbox("é€‰æ‹©æ¨¡å‹ ID", model_options + ["æ‰‹åŠ¨è¾“å…¥"])
model_id = st.sidebar.text_input("è‡ªå®šä¹‰ Model ID", value="deepseek-chat") if selected_model == "æ‰‹åŠ¨è¾“å…¥" else selected_model

# --- æ ¸å¿ƒ Prompt æ·±åº¦é‡æ„ ---

# ç¬¬ä¸€é˜¶æ®µï¼šå¿«é€Ÿå¯¼æ¼”é€»è¾‘
PROMPT_STAGE_1 = """ä½ æ˜¯ä¸€ä¸ªç”µå½±å¯¼æ¼”ã€‚
ä»»åŠ¡ï¼šè¯·å°†ä»¥ä¸‹è¿ç»­æ–‡æœ¬æ‹†åˆ†ä¸ºé€»è¾‘åˆ†é•œã€‚
æ ¸å¿ƒæ ‡å‡†ï¼šæ¯å½“å‡ºç°ã€æ–°åœºæ™¯ã€æ–°è§’è‰²è¯´è¯ã€æ–°çš„å¤§å¹…åº¦åŠ¨ä½œã€‘æ—¶ï¼Œå¿…é¡»å¼€å¯æ–°åˆ†é•œã€‚
è¦æ±‚ï¼š
- ä¸¥ç¦æ”¹åŠ¨åŸæ–‡ã€‚
- æ ¼å¼ï¼šåºå·.å†…å®¹
"""

# ç¬¬äºŒé˜¶æ®µï¼šé€»è¾‘å®¡è®¡å¸ˆï¼ˆæ ¸å¿ƒçº åé€»è¾‘ï¼‰
PROMPT_STAGE_2 = """ä½ æ˜¯ä¸€ä¸ªæ‹¥æœ‰æè‡´ç»†èŠ‚æ§çš„ã€åˆ†é•œé€»è¾‘å®¡è®¡å¸ˆã€‘ã€‚
ç¬¬ä¸€éåˆ†é•œå­˜åœ¨çº¦15%-50%çš„ç»†èŠ‚ç–å¿½ï¼Œä½ çš„å”¯ä¸€ä»»åŠ¡æ˜¯ã€ä¿®æ­£ç–å¿½ã€‘ã€‚

ä½ éœ€è¦é’ˆå¯¹ç¬¬ä¸€éåˆ†é•œï¼Œæ‰§è¡Œä»¥ä¸‹å®¡è®¡æŒ‡ä»¤ï¼š

1. **ä¿®æ­£â€œè¯¥åˆ†ä¸åˆ†â€çš„æ‡’æƒ°ï¼ˆé•¿é•œæ‹†åˆ†ï¼‰**ï¼š
   - é‡ç‚¹æ£€æŸ¥å­—æ•°æ¥è¿‘æˆ–è¶…è¿‡35å­—çš„åˆ†é•œã€‚
   - ã€å®¡è®¡ç»†èŠ‚ã€‘ï¼šå³ä¾¿è¿™35å­—æ²¡æ ‡ç‚¹ï¼Œåªè¦ä¸­é—´å‘ç”Ÿäº†ã€çœ¼ç¥äº¤æ±‡ã€è§’è‰²åˆ‡æ¢ã€å°åŠ¨ä½œå˜åŒ–ã€åœ°ç‚¹å¾®ç§»ã€‘ï¼Œä½ å¿…é¡»æ‰§è¡Œå¤–ç§‘æ‰‹æœ¯å¼æ‹†åˆ†ã€‚
   - ç»ä¸å…è®¸è®©é•¿è¾¾5ç§’çš„è§†é¢‘åªç”¨ä¸€ä¸ªç”»é¢ï¼Œé™¤éå‰§æƒ…çœŸçš„æ²¡æœ‰ä»»ä½•åŠ¨é™ã€‚

2. **ä¿®æ­£â€œè¯¥åˆä¸åˆâ€çš„ç ´ç¢ï¼ˆç¢é•œåˆå¹¶ï¼‰**ï¼š
   - æ£€æŸ¥è¿ç»­çš„æçŸ­åˆ†é•œï¼ˆå¦‚10å­—ä»¥å†…ï¼‰ã€‚
   - å¦‚æœå®ƒä»¬å±äºã€åŒä¸€ä¸ªäººçš„è¿ç»­åŠ¨ä½œã€‘æˆ–ã€åŒä¸€ä¸ªé™æ­¢åœºæ™¯ã€‘ï¼Œä¸”åˆå¹¶åæ€»å­—æ•°ã€ä¸è¶…è¿‡35å­—ã€‘ï¼Œè¯·å¼ºåˆ¶åˆå¹¶ã€‚
   - ç†ç”±ï¼šé¿å…ç”»é¢åƒå¹»ç¯ç‰‡ä¸€æ ·ä¹±é—ªï¼Œå‡å°‘è§‚ä¼—è§†è§‰ç–²åŠ³ã€‚

3. **æ–‡æœ¬æº¯æºå¯¹é½**ï¼š
   - ä½ å¿…é¡»æ ¸å¯¹åŸå§‹å…¨æ–‡ï¼Œç¬¬ä¸€éåˆ†é•œä¸¢æ‰çš„ä»»ä½•ä¸€ä¸ªè™šè¯ã€æ„Ÿå¹è¯ï¼Œä½ éƒ½è¦ç²¾å‡†åœ°å¡«å›å»ã€‚

**è¾“å‡ºåŸåˆ™**ï¼š
- ä¸è¦æ¨ç¿»ç¬¬ä¸€éåšå¾—å¥½çš„åœ°æ–¹ã€‚
- ä½ çš„è¾“å‡ºå¿…é¡»æ˜¯ï¼šåºå·.å†…å®¹ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ã€‚
- ä¸¥ç¦æ·»åŠ ä½ çš„ä»»ä½•è§£é‡Šã€‚
"""

# --- ä¸»ç•Œé¢ ---
uploaded_file = st.file_uploader("ä¸Šä¼  TXT æ–‡æ¡ˆ", type=['txt'])

if uploaded_file is not None:
    # å½»åº•è„±æ•ï¼šæŠ¹é™¤ä¸€åˆ‡æ ¼å¼
    raw_content = uploaded_file.getvalue().decode("utf-8")
    cleaned_content = "".join(raw_content.split())
    
    col_in, col_s1, col_s2 = st.columns([1, 1, 1.2])
    
    with col_in:
        st.subheader("1. åŸå§‹é€»è¾‘æµ")
        st.text_area("Input Stream", cleaned_content, height=400)

    if st.button("ğŸš€ å¼€å§‹é€»è¾‘å®¡è®¡åˆ†é•œ"):
        if not api_key:
            st.error("è¯·é…ç½® API Key")
        else:
            client = OpenAI(api_key=api_key, base_url=base_url)
            try:
                # --- ç¬¬ä¸€é˜¶æ®µ ---
                with st.status("é˜¶æ®µä¸€ï¼šæ­£åœ¨å»ºç«‹é€»è¾‘éª¨æ¶...") as status:
                    res1 = client.chat.completions.create(
                        model=model_id,
                        messages=[
                            {"role": "system", "content": PROMPT_STAGE_1},
                            {"role": "user", "content": cleaned_content}
                        ],
                        temperature=0.3
                    )
                    stage1_out = res1.choices[0].message.content
                    with col_s1:
                        st.subheader("2. ç¬¬ä¸€éï¼šé€»è¾‘åˆç¨¿")
                        st.text_area("Stage 1", stage1_out, height=400)
                    
                    # --- ç¬¬äºŒé˜¶æ®µ ---
                    status.update(label="é˜¶æ®µäºŒï¼šé€»è¾‘å®¡è®¡è¡¥æ¼ä¸­ï¼ˆå¤„ç†é•¿é•œ/åˆå¹¶ç¢é•œï¼‰...")
                    # å…³é”®ç‚¹ï¼šå°†åŸå§‹æ–‡æœ¬å’Œè‰ç¨¿åŒæ—¶å–‚ç»™å®ƒï¼Œå»ºç«‹å®¡è®¡å¯¹æ¯”
                    res2 = client.chat.completions.create(
                        model=model_id,
                        messages=[
                            {"role": "system", "content": PROMPT_STAGE_2},
                            {"role": "user", "content": f"ã€åŸå§‹å…¨æ–‡ã€‘ï¼š{cleaned_content}\n\nã€å¾…å®¡è®¡è‰ç¨¿ã€‘ï¼š{stage1_out}"}
                        ],
                        temperature=0.2 
                    )
                    final_out = res2.choices[0].message.content
                    status.update(label="å®¡è®¡çº åå®Œæˆï¼", state="complete")
                    
                with col_s2:
                    st.subheader("3. æœ€ç»ˆå®¡è®¡å¯¹é½ç‰ˆ")
                    st.text_area("Final Audit Output", final_out, height=400)
                    st.download_button("ä¸‹è½½ç»“æœ", final_out, file_name="audited_storyboard.txt")
                    
            except Exception as e:
                st.error(f"å¤„ç†å¤±è´¥: {str(e)}")

# --- é¿å‘æŒ‡å— ---
st.markdown("---")
st.warning("""
**ä¸ºä»€ä¹ˆ AI ä¼šâ€œå°†é”™å°±é”™â€ï¼Ÿ**
AI çš„å¤©æ€§æ˜¯é¡ºä»ã€‚å¦‚æœç¬¬ä¸€éç»™äº†å®ƒä¸€ä¸ªé”™è¯¯çš„ç»“æ„ï¼Œå®ƒä¼šè®¤ä¸ºé‚£æ˜¯â€œäº‹å®â€ã€‚
**è§£å†³æ–¹æ¡ˆï¼š**
åœ¨ç¬¬äºŒæ­¥ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ã€åŸå§‹å…¨æ–‡ã€‘ä¸ã€è‰ç¨¿ã€‘å¯¹å†²ï¼Œæ˜ç¡®å‘Šè¯‰å®ƒâ€œè‰ç¨¿æœ‰50%ç–å¿½â€ï¼Œå¼ºåˆ¶å®ƒé‡æ–°æ‰«æé•¿å¥å­å†…éƒ¨çš„åœºæ™¯å˜åŒ–ã€‚
""")
