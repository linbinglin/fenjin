import streamlit as st
from openai import OpenAI
import re

# é¡µé¢é…ç½®
st.set_page_config(page_title="AI ç”µå½±è§£è¯´æ·±åº¦åˆ†é•œå·¥å…·", page_icon="ğŸ¬", layout="wide")

st.title("ğŸ¬ ç”µå½±è§£è¯´æ–‡æ¡ˆæ·±åº¦åˆ†é•œå·¥å…·")
st.markdown("""
**æ ¸å¿ƒé€»è¾‘æ›´æ–°ï¼š**
1. **å¼ºåˆ¶é‡æ„**ï¼šç¨‹åºä¼šè‡ªåŠ¨æŠ¹é™¤åŸæ–‡çš„æ‰€æœ‰æ®µè½æ ¼å¼ï¼Œè¿«ä½¿ AI å¿…é¡»é€šè¿‡é˜…è¯»ç†è§£æ¥é‡æ–°åˆ†é•œã€‚
2. **ä¸¤æ­¥å®¡æ ¸**ï¼šå…ˆè¿›è¡Œå‰§æƒ…é€»è¾‘æ‹†è§£ï¼Œå†è¿›è¡ŒèŠ‚å¥ä¸å­—æ•°å¹³æ»‘ä¼˜åŒ–ã€‚
""")

# --- ä¾§è¾¹æ é…ç½® ---
st.sidebar.header("âš™ï¸ API ä¸æ¨¡å‹è®¾ç½®")
api_key = st.sidebar.text_input("è¯·è¾“å…¥ API Key", type="password")
base_url = st.sidebar.text_input("ä¸­è½¬æ¥å£åœ°å€", value="https://blog.tuiwen.xyz/v1")

# å…è®¸ç”¨æˆ·é€‰æ‹©æˆ–è¾“å…¥ Model ID
model_options = [
    "deepseek-chat", 
    "gpt-4o", 
    "claude-3-5-sonnet-20240620", 
    "gemini-1.5-pro", 
    "grok-2",
    "doubao-pro-128k"
]
selected_model = st.sidebar.selectbox("é€‰æ‹©æˆ–è¾“å…¥æ¨¡å‹åç§° (Model ID)", model_options + ["æ‰‹åŠ¨è¾“å…¥è‡ªå®šä¹‰ ID"])
if selected_model == "æ‰‹åŠ¨è¾“å…¥è‡ªå®šä¹‰ ID":
    model_id = st.sidebar.text_input("è¯·è¾“å…¥è‡ªå®šä¹‰ Model ID", value="deepseek-chat")
else:
    model_id = selected_model

# --- æ ¸å¿ƒ Prompt å®šä¹‰ ---

# ç¬¬ä¸€é˜¶æ®µï¼šå‰¥ç¦»æ ¼å¼åçš„æ·±åº¦å‰§æƒ…è§£æ
PROMPT_STAGE_1 = """ä½ æ˜¯ä¸€ä¸ªé¡¶çº§çš„ç”µå½±å‰ªè¾‘å¸ˆå’Œåˆ†é•œå¸ˆã€‚
æˆ‘ä¼šç»™ä½ ä¸€æ®µæ²¡æœ‰ä»»ä½•æ¢è¡Œç¬¦çš„è¿ç»­æ–‡æœ¬ã€‚è¯·ä½ æ·±åº¦é˜…è¯»è¿™æ®µæ–‡å­—ï¼Œæ ¹æ®å‰§æƒ…é€»è¾‘è¿›è¡Œåˆæ­¥åˆ†é•œã€‚

åˆ†é•œæ ‡å‡†ï¼ˆä¼˜å…ˆçº§æ’åºï¼‰ï¼š
1. åœºæ™¯åˆ‡æ¢ï¼šä»å®¤å†…åˆ°å®¤å¤–ï¼Œæˆ–ä»åœ°ç‚¹Aåˆ°åœ°ç‚¹Bï¼Œå¿…é¡»åˆ†é•œã€‚
2. åŠ¨ä½œ/è§†çº¿æ”¹å˜ï¼šè§’è‰²åšä¸€ä¸ªå¤§å¹…åº¦åŠ¨ä½œï¼Œæˆ–è§†çº¿è½¬å‘ï¼Œå¿…é¡»åˆ†é•œã€‚
3. è§’è‰²å¯¹è¯ï¼šä¸åŒè§’è‰²è¯´è¯ï¼Œå¿…é¡»åˆ†é•œã€‚
4. å™è¿°èŠ‚å¥ï¼šå½“å™è¿°é‡ç‚¹å‘ç”Ÿä½ç§»æ—¶ï¼Œå¿…é¡»åˆ†é•œã€‚

ä¸¥æ ¼è¦æ±‚ï¼š
- ä¸¥ç¦åˆ é™¤ã€æ·»åŠ æˆ–æ”¹åŠ¨åŸæ–‡ä¸­ä»»ä½•ä¸€ä¸ªå­—ã€‚
- ä¸è¦ç†ä¼šåŸæ–‡å¯èƒ½çš„æ ¼å¼ï¼Œå®Œå…¨åŸºäºä½ å¯¹å‰§æƒ…çš„ç†è§£åˆ’åˆ†ã€‚
- æ ¼å¼ï¼šæ•°å­—åºå·.å†…å®¹
"""

# ç¬¬äºŒé˜¶æ®µï¼šèŠ‚å¥å¹³æ»‘ä¸æœ€ç»ˆå¯¹é½æ ¡å¯¹
PROMPT_STAGE_2 = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç”µå½±åæœŸç»Ÿç­¹ã€‚
è¯·å¯¹åˆç‰ˆåˆ†é•œè„šæœ¬è¿›è¡Œä¼˜åŒ–æ ¡å¯¹ï¼š
1. æ£€æŸ¥é—æ¼ï¼šå¯¹ç…§æä¾›çš„åŸå§‹å…¨æ–‡ï¼Œç¡®ä¿åˆ†é•œåçš„å†…å®¹æ²¡æœ‰é—æ¼ä»»ä½•ä¸€ä¸ªå­—ã€‚
2. èŠ‚å¥ä¼˜åŒ–ï¼šå¦‚æœæŸä¸ªåˆ†é•œçš„æ–‡å­—è¿‡é•¿ï¼ˆä¾‹å¦‚è¶…è¿‡ 50 ä¸ªå­—ï¼‰ï¼Œè¯·åœ¨ä¸ç ´åè¯­æ„çš„å‰æä¸‹ï¼Œå¯»æ‰¾åˆé€‚çš„é€»è¾‘åœé¡¿ç‚¹å°†å…¶æ‹†åˆ†ä¸ºä¸¤ä¸ªç›¸è¿çš„åˆ†é•œï¼Œä»¥é€‚åº”è§†é¢‘5-8ç§’çš„ç”»é¢åœç•™æ—¶é—´ã€‚
3. é€»è¾‘è‡ªç”±åº¦ï¼šä¸è¦æ­»æ¿åœ°é™åˆ¶åœ¨35å­—ï¼Œåªè¦åˆ†é•œé€»è¾‘åˆç†ä¸”æ–¹ä¾¿ç”»é¢å¯¹é½ï¼Œ40-50å­—ä¹Ÿæ˜¯å…è®¸çš„ã€‚
4. æœ€ç»ˆè¾“å‡ºï¼šä»…è¾“å‡ºæœ€ç»ˆçš„åˆ†é•œåˆ—è¡¨ï¼Œæ ¼å¼ä¸ºâ€œåºå·.æ–‡æ¡ˆå†…å®¹â€ã€‚
"""

# --- ä¸»ç•Œé¢é€»è¾‘ ---
uploaded_file = st.file_uploader("é€‰æ‹©æœ¬åœ° TXT æ–‡æ¡ˆæ–‡ä»¶", type=['txt'])

if uploaded_file is not None:
    # 1. è¯»å–å¹¶æ¸…æ´—æ–‡æœ¬ï¼ˆå»æ‰æ‰€æœ‰æ¢è¡Œï¼Œé˜²æ­¢ AI å·æ‡’æ²¿ç”¨æ—§æ ¼å¼ï¼‰
    raw_content = uploaded_file.getvalue().decode("utf-8")
    cleaned_content = re.sub(r'\s+', '', raw_content) # æŠ¹é™¤æ‰€æœ‰ç©ºæ ¼ã€æ¢è¡Œã€åˆ¶è¡¨ç¬¦
    
    col1, col2 = st.columns(2)
    with col1:
        st.subheader("ğŸ“¦ AI è·å–çš„åŸå§‹è¾“å…¥")
        st.info("ç³»ç»Ÿå·²è‡ªåŠ¨æŠ¹é™¤æ‰€æœ‰æ®µè½æ ¼å¼ï¼Œå¼ºåˆ¶ AI è¿›è¡Œé€»è¾‘è§£æã€‚")
        st.text_area("æ¸…æ´—åçš„æ–‡æœ¬ (æµå¼)", cleaned_content, height=300)

    if st.button("ğŸš€ å¼€å§‹æ·±åº¦é€»è¾‘åˆ†é•œ"):
        if not api_key:
            st.error("è¯·å…ˆåœ¨ä¾§è¾¹æ è¾“å…¥ API Keyï¼")
        else:
            client = OpenAI(api_key=api_key, base_url=base_url)
            
            try:
                # --- ç¬¬ä¸€é˜¶æ®µï¼šåˆæ¬¡å‰§æƒ…æ‹†è§£ ---
                with st.spinner("é˜¶æ®µ 1/2ï¼šæ­£åœ¨æ·±åº¦è§£æå‰§æƒ…é€»è¾‘..."):
                    res1 = client.chat.completions.create(
                        model=model_id,
                        messages=[
                            {"role": "system", "content": PROMPT_STAGE_1},
                            {"role": "user", "content": f"è¯·å¯¹ä»¥ä¸‹è¿ç»­æ–‡æœ¬è¿›è¡Œæ·±åº¦åˆ†é•œï¼š\n\n{cleaned_content}"}
                        ],
                        temperature=0.4 # é€‚ä¸­æ¸©åº¦ï¼Œå…è®¸ AI å¯¹å‰§æƒ…æœ‰ç†è§£ç©ºé—´
                    )
                    stage1_result = res1.choices[0].message.content
                
                # --- ç¬¬äºŒé˜¶æ®µï¼šèŠ‚å¥æ ¡å¯¹ä¸é˜²é—æ¼ ---
                with st.spinner("é˜¶æ®µ 2/2ï¼šæ­£åœ¨è¿›è¡Œå­—æ•°æ ¡å¯¹ä¸èŠ‚å¥å¹³æ»‘..."):
                    res2 = client.chat.completions.create(
                        model=model_id,
                        messages=[
                            {"role": "system", "content": PROMPT_STAGE_2},
                            {"role": "user", "content": f"åŸå§‹å…¨æ–‡ï¼š\n{cleaned_content}\n\nåˆç‰ˆåˆ†é•œï¼š\n{stage1_result}"}
                        ],
                        temperature=0.2 # è¾ƒä½æ¸©åº¦ï¼Œç¡®ä¿ä¸¥è°¨å’Œä¸é—æ¼
                    )
                    final_result = res2.choices[0].message.content
                
                st.success("âœ¨ åˆ†é•œå¤„ç†å®Œæˆï¼")
                with col2:
                    st.subheader("ğŸ¬ æœ€ç»ˆåˆ†é•œè„šæœ¬")
                    st.text_area("Final Output", final_result, height=450)
                    
                    st.download_button(
                        label="ğŸ“¥ ä¸‹è½½æœ€ç»ˆåˆ†é•œè„šæœ¬",
                        data=final_result,
                        file_name=f"æ·±åº¦åˆ†é•œ_{uploaded_file.name}",
                        mime="text/plain"
                    )

            except Exception as e:
                st.error(f"å‘ç”Ÿé”™è¯¯ï¼š{str(e)}")

# --- åº•éƒ¨è´´å£« ---
st.markdown("---")
st.caption("æ³¨ï¼šå¦‚æœæ¨¡å‹å“åº”è¾ƒæ…¢ï¼Œè¯·æ£€æŸ¥ä¸­è½¬æ¥å£çš„ç¨³å®šæ€§ã€‚æ¨èä½¿ç”¨ Claude-3.5-Sonnet æˆ– GPT-4o è¿›è¡Œæ­¤ç±»æ·±å±‚é€»è¾‘åˆ†æã€‚")
